<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Ø¹Ø§Ø±Ø¶ JSON ÙˆØ¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø§Ù„Ù€ IDs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        }
        :root {
            --bg: #f4f7fb;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #475569;
            --accent: #2563eb;
            --accent-light: #3b82f6;
            --border: #e2e8f0;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --radius: 20px;
        }
        body.dark {
            --bg: #0f172a;
            --surface: #1e293b;
            --text: #f1f5f9;
            --text-light: #94a3b8;
            --accent: #3b82f6;
            --border: #334155;
            --shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        body {
            background: var(--bg);
            color: var(--text);
            transition: background 0.2s, color 0.2s;
            padding: 16px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .header h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .theme-toggle {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 40px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
        }
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab-btn {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 40px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 500;
            box-shadow: var(--shadow);
        }
        .tab-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .input-area {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        textarea, input[type="text"] {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: 16px;
            background: var(--bg);
            color: var(--text);
            font-family: monospace;
            margin-bottom: 12px;
            resize: vertical;
        }
        textarea:focus, input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.2);
        }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }
        button {
            padding: 10px 18px;
            border: none;
            border-radius: 40px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: 0.2s;
            box-shadow: var(--shadow);
        }
        button.primary {
            background: var(--accent);
            color: white;
            border: none;
        }
        button.primary:hover {
            background: var(--accent-light);
        }
        button:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
        }
        .search-box {
            width: 100%;
            padding: 14px 18px;
            border: 1.5px solid var(--border);
            border-radius: 50px;
            background: var(--surface);
            color: var(--text);
            margin-bottom: 20px;
            padding-right: 45px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%2394a3b8" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>');
            background-repeat: no-repeat;
            background-position: right 18px center;
        }
        .search-box:focus {
            outline: none;
            border-color: var(--accent);
        }
        .layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        @media (max-width:768px){
            .layout{grid-template-columns:1fr;}
        }
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px,1fr));
            gap: 12px;
        }
        .image-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            transition: 0.2s;
        }
        .image-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .image-preview {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            cursor: pointer;
        }
        .badges {
            padding: 8px 8px 4px;
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
        }
        .badge-order {
            background: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
        }
        .badge-private {
            background: #f97316;
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
        }
        .image-url {
            padding: 0 8px 8px;
            font-size: 0.65rem;
            color: var(--text-light);
            word-break: break-all;
            direction: ltr;
        }
        .image-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 0 8px 8px;
        }
        .image-actions button {
            flex: 1 1 auto;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 6px 4px;
            font-size: 0.7rem;
            color: var(--text);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            min-width: 50px;
        }
        .image-actions button:hover {
            background: var(--accent);
            color: white;
        }
        .info-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        .info-card h3 {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent);
        }
        .user-info-grid {
            display: grid;
            grid-template-columns: repeat(2,1fr);
            gap: 10px;
        }
        .user-item {
            background: var(--bg);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
        }
        .user-item .label {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-bottom: 4px;
        }
        .user-item .value {
            font-weight: 600;
        }
        .location-item {
            background: var(--bg);
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .coord-row {
            display: flex;
            justify-content: space-between;
            background: var(--surface);
            padding: 8px 10px;
            border-radius: 12px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.8rem;
        }
        .map-placeholder {
            background: #e2e8f0;
            border-radius: 12px;
            height: 120px;
            margin: 10px 0;
            overflow: hidden;
        }
        .map-placeholder iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }
        .location-actions {
            display: flex;
            gap: 8px;
        }
        .location-actions button,
        .location-actions a {
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            color: var(--text);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .location-actions button:hover,
        .location-actions a:hover {
            background: var(--accent);
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content img {
            max-width: 95%;
            max-height: 85%;
            border-radius: 20px;
        }
        .modal-close {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-size: 2rem;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-prev { right: 10px; }
        .modal-next { left: 10px; }
        @media(min-width:768px){
            .modal-prev { right: 30px; }
            .modal-next { left: 30px; }
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: white;
            padding: 10px 24px;
            border-radius: 40px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 0.9rem;
            z-index: 2000;
            animation: fadeInOut 2s ease forwards;
        }
        @keyframes fadeInOut {
            0% { opacity:0; transform: translateX(-50%) translateY(10px); }
            15% { opacity:1; transform: translateX(-50%) translateY(0); }
            85% { opacity:1; transform: translateX(-50%) translateY(0); }
            100% { opacity:0; transform: translateX(-50%) translateY(-10px); }
        }
        .empty-state {
            color: var(--text-light);
            text-align: center;
            padding: 40px;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            color: var(--text-light);
            font-size: 0.8rem;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }
        .token-input {
            direction: ltr;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-cube" style="color:var(--accent);"></i> Ø¹Ø§Ø±Ø¶ JSON ÙˆØ¬Ù„Ø¨ Ø¨Ø§Ù„Ù€ IDs</h1>
            <div class="theme-toggle" onclick="document.body.classList.toggle('dark')">
                <i class="fas fa-moon"></i>
                <span>Ù„ÙŠÙ„ÙŠ</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="jsonTab">ğŸ“„ JSON</button>
            <button class="tab-btn" data-tab="apiTab">ğŸŒ Ø¬Ù„Ø¨ Ø¨Ø§Ù„Ù€ IDs</button>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ JSON (Ø§Ù„Ø£ÙˆÙ„) -->
        <div id="jsonTab" class="tab-content active">
            <div class="input-area">
                <textarea id="jsonInput" placeholder="Ø§Ù„ØµÙ‚ JSON Ù‡Ù†Ø§ (ÙŠØ¯Ø¹Ù… result.user Ø£Ùˆ result.users)..."></textarea>
                <div class="btn-group">
                    <button class="primary" onclick="parseJSON()"><i class="fas fa-play"></i> ØªØ­Ù„ÙŠÙ„</button>
                    <button onclick="pasteJSON()"><i class="fas fa-paste"></i> Ù„ØµÙ‚</button>
                    <button onclick="clearJSON()"><i class="fas fa-trash"></i> Ù…Ø³Ø­</button>
                    <button onclick="loadSample()"><i class="fas fa-flask"></i> Ø¹ÙŠÙ†Ø©</button>
                </div>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ API (Ø§Ù„Ø«Ø§Ù†ÙŠ) -->
        <div id="apiTab" class="tab-content">
            <div class="input-area">
                <label style="display:block; margin-bottom:8px;"><i class="fas fa-key"></i> Session Token</label>
                <input type="text" id="sessionToken" class="token-input" placeholder="r:ad6f7cf8f71a2637eee5a154ad511f55" value="r:ad6f7cf8f71a2637eee5a154ad511f55">
                
                <label style="display:block; margin:16px 0 8px;"><i class="fas fa-id-card"></i> Ù‚Ø§Ø¦Ù…Ø© User IDs (ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚ JSON Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©)</label>
                <textarea id="userIdsInput" placeholder='Ù…Ø«Ø§Ù„: ["uFW8Q24WIb", "iz4Q7sGGZp"] Ø£Ùˆ ÙƒÙ„ Ø³Ø·Ø± ID&#10;uFW8Q24WIb&#10;iz4Q7sGGZp' rows="5"></textarea>
                
                <div class="btn-group">
                    <button class="primary" onclick="fetchUsersByIds()"><i class="fas fa-cloud-download-alt"></i> Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    <button onclick="clearApi()"><i class="fas fa-trash"></i> Ù…Ø³Ø­</button>
                    <button onclick="loadSampleIds()"><i class="fas fa-flask"></i> ØªØ¬Ø±Ø¨Ø© Ø¨Ø§Ù„Ø¹ÙŠÙ†Ø©</button>
                </div>
                <div id="apiProgress" class="progress-bar" style="display: none;">
                    <div class="progress-fill" id="apiProgressFill"></div>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„) -->
        <div id="stats" class="stats" style="display: none;"></div>

        <!-- Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« (ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„) -->
        <input type="text" id="searchInput" class="search-box" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙˆØ±Ø©..." style="display: none;">

        <!-- Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: ØµÙˆØ± + Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¬Ø§Ù†Ø¨ÙŠØ© -->
        <div class="layout">
            <div>
                <h2 style="margin-bottom:16px;"><i class="fas fa-images" style="color:var(--accent);"></i> Ø§Ù„ØµÙˆØ±</h2>
                <div id="imagesContainer" class="images-grid">
                    <div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø¨Ø¹Ø¯</div>
                </div>
            </div>
            <div>
                <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù… (Ø¥Ø°Ø§ ÙˆØ¬Ø¯) -->
                <div class="info-card" id="userInfoCard" style="display: none;">
                    <h3><i class="fas fa-user"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
                    <div id="userInfo" class="user-info-grid"></div>
                </div>
                <!-- Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ -->
                <div class="info-card">
                    <h3><i class="fas fa-map-marked-alt"></i> Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹</h3>
                    <div id="locationsContainer"></div>
                </div>
                <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø© -->
                <div class="info-card">
                    <h3><i class="fas fa-chart-simple"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª JSON</h3>
                    <div id="advancedStats"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…ØªØ§Ø­Ø© â€” ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨</p>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªÙƒØ¨ÙŠØ± Ø§Ù„ØµÙˆØ± -->
    <div id="imageModal" class="modal" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal(event)">&times;</span>
            <span class="modal-nav modal-prev" onclick="prevImage(event)"><i class="fas fa-chevron-right"></i></span>
            <span class="modal-nav modal-next" onclick="nextImage(event)"><i class="fas fa-chevron-left"></i></span>
            <img id="modalImage" src="" alt="">
        </div>
    </div>

    <script>
        (function() {
            // ---------- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ----------
            let currentImages = [];          // Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙˆØ± Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§ (url, order, isPrivate, userHandle)
            let currentLocations = [];        // Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©
            let currentImageIndex = 0;         // Ø§Ù„ÙÙ‡Ø±Ø³ Ù„Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            let activeTab = 'jsonTab';         // Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù†Ø´Ø·

            // ---------- Ø¯ÙˆØ§Ù„ Ø¹Ø§Ù…Ø© ----------
            function showToast(message) {
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);
            }

            // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const tabId = this.dataset.tab;
                    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    activeTab = tabId;
                });
            });

            // ---------- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ (JSON) ----------
            window.pasteJSON = async function() {
                try {
                    const text = await navigator.clipboard.readText();
                    document.getElementById('jsonInput').value = text;
                    parseJSON();
                } catch (err) {
                    showToast('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø§ÙØ¸Ø©ØŒ Ø§Ù„ØµÙ‚ ÙŠØ¯ÙˆÙŠØ§Ù‹');
                }
            };

            window.parseJSON = function() {
                const jsonStr = document.getElementById('jsonInput').value.trim();
                if (!jsonStr) { showToast('Ø£Ø¯Ø®Ù„ JSON Ø£ÙˆÙ„Ø§Ù‹'); return; }
                try {
                    const data = JSON.parse(jsonStr);
                    processUserData(data);
                } catch (e) {
                    showToast('âŒ JSON ØºÙŠØ± ØµØ§Ù„Ø­: ' + e.message);
                }
            };

            // Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù…Ø´ØªØ±ÙƒØ©)
            function processUserData(data) {
                const images = [];
                const seenUrls = new Set();
                const locations = [];

                const addImage = (url, order, isPrivate, userHandle) => {
                    if (url && /\.(jpg|jpeg|png|gif|webp|bmp)(\?.*)?$/i.test(url) && !seenUrls.has(url)) {
                        seenUrls.add(url);
                        images.push({ url, order, isPrivate, userHandle });
                    }
                };

                const addLocation = (location, name) => {
                    if (location) {
                        const lon = location.longitude || location.lon || location.lng;
                        const lat = location.latitude || location.lat;
                        if (lon !== undefined && lat !== undefined) {
                            locations.push({ longitude: lon, latitude: lat, name: name || 'Ù…ÙˆÙ‚Ø¹' });
                        }
                    }
                };

                // Ø­Ø§Ù„Ø© result.users (Ù…ØµÙÙˆÙØ©)
                if (data?.result?.users && Array.isArray(data.result.users)) {
                    data.result.users.forEach(user => {
                        const userHandle = user.userHandle || null;
                        if (user.userImages && Array.isArray(user.userImages)) {
                            user.userImages.forEach(img => {
                                const url = img?.imageFile?.url;
                                addImage(url, img.order, img.isPrivate, userHandle);
                            });
                        }
                        addLocation(user.location, user.name);
                    });
                }
                // Ø­Ø§Ù„Ø© result.user (Ù…ÙØ±Ø¯)
                else if (data?.result?.user) {
                    const user = data.result.user;
                    const userHandle = user.userHandle || null;
                    if (user.userImages && Array.isArray(user.userImages)) {
                        user.userImages.forEach(img => {
                            const url = img?.imageFile?.url;
                            addImage(url, img.order, img.isPrivate, userHandle);
                        });
                    }
                    addLocation(user.location, user.name);
                }

                currentImages = images;
                currentLocations = locations;

                displayImages(images);
                displayLocations(locations);
                updateStats(images, locations);
                displayAdvancedStats(data);

                document.getElementById('stats').style.display = 'flex';
                document.getElementById('searchInput').style.display = 'block';
                document.getElementById('searchInput').value = '';

                // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù…
                let firstUser = null;
                if (data?.result?.users && data.result.users.length > 0) firstUser = data.result.users[0];
                else if (data?.result?.user) firstUser = data.result.user;
                if (firstUser) {
                    document.getElementById('userInfoCard').style.display = 'block';
                    displayUserInfo(firstUser);
                } else {
                    document.getElementById('userInfoCard').style.display = 'none';
                }
            }

            window.clearJSON = function() {
                document.getElementById('jsonInput').value = '';
                clearAllData();
            };

            // ---------- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ (API) ----------
            window.fetchUsersByIds = async function() {
                const token = document.getElementById('sessionToken').value.trim();
                if (!token) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Session Token'); return; }

                let idsText = document.getElementById('userIdsInput').value.trim();
                if (!idsText) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù€ IDs'); return; }

                // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ ÙƒÙ€ JSON Ø£ÙˆÙ„Ø§Ù‹ (Ù…ØµÙÙˆÙØ©)
                let userIds = [];
                try {
                    const parsed = JSON.parse(idsText);
                    if (Array.isArray(parsed)) userIds = parsed;
                } catch (e) {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† JSON ØµØ§Ù„Ø­Ø§Ù‹ØŒ Ù†ÙØªØ±Ø¶ Ø£Ù† ÙƒÙ„ Ø³Ø·Ø± Ù‡Ùˆ ID
                    userIds = idsText.split(/\n|,| /).map(s => s.trim()).filter(s => s.length > 0);
                }

                if (userIds.length === 0) { showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ ID'); return; }

                // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                const progressBar = document.getElementById('apiProgress');
                const progressFill = document.getElementById('apiProgressFill');
                progressBar.style.display = 'block';
                progressFill.style.width = '0%';

                const headers = {
                    'X-Parse-Application-Id': 'Wcf9kCIeN7QcB0ij0Mz0mgRXpXBwoY6RAlTztx1z',
                    'X-Parse-Client-Key': 'BIja8DnCgRsPuWBoLZ8zBqkDxTM8t0R6D4BOAgxt',
                    'X-Parse-Session-Token': token,
                    'Content-Type': 'application/json; charset=utf-8',
                    'Accept': '*/*'
                };

                const url = 'https://d3nr614fs94gvh.cloudfront.net/parse/functions/getUserProfile';

                let fetchedUsers = [];
                let failedIds = [];

                for (let i = 0; i < userIds.length; i++) {
                    const userId = userIds[i];
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({ userId: userId })
                        });
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        const data = await response.json();
                        // Ù†ØªÙˆÙ‚Ø¹ Ø£Ù† ØªØ£ØªÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ø´ÙƒÙ„ { result: { user: ... } }
                        if (data?.result?.user) {
                            fetchedUsers.push(data.result.user);
                        } else {
                            failedIds.push(userId);
                        }
                    } catch (err) {
                        console.error(`ÙØ´Ù„ Ø¬Ù„Ø¨ ${userId}:`, err);
                        failedIds.push(userId);
                    }
                    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                    progressFill.style.width = ((i+1) / userIds.length * 100) + '%';
                }

                progressBar.style.display = 'none';

                if (fetchedUsers.length === 0) {
                    showToast('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†');
                    return;
                }

                // Ø§Ù„Ø¢Ù† Ù„Ø¯ÙŠÙ†Ø§ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (fetchedUsers)
                // Ù†Ù‚ÙˆÙ… Ø¨ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù…Ù†Ù‡Ù…
                const images = [];
                const seenUrls = new Set();
                const locations = [];

                fetchedUsers.forEach(user => {
                    const userHandle = user.userHandle || null;
                    if (user.userImages && Array.isArray(user.userImages)) {
                        user.userImages.forEach(img => {
                            const url = img?.imageFile?.url;
                            if (url && /\.(jpg|jpeg|png|gif|webp|bmp)(\?.*)?$/i.test(url) && !seenUrls.has(url)) {
                                seenUrls.add(url);
                                images.push({ url, order: img.order, isPrivate: img.isPrivate, userHandle });
                            }
                        });
                    }
                    if (user.location) {
                        const lon = user.location.longitude || user.location.lon || user.location.lng;
                        const lat = user.location.latitude || user.location.lat;
                        if (lon !== undefined && lat !== undefined) {
                            locations.push({ longitude: lon, latitude: lat, name: user.name || 'Ù…ÙˆÙ‚Ø¹' });
                        }
                    }
                });

                currentImages = images;
                currentLocations = locations;

                displayImages(images);
                displayLocations(locations);
                updateStats(images, locations);

                // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©: Ù†Ù…Ø±Ø± ÙƒØ§Ø¦Ù†Ù‹Ø§ ÙˆÙ‡Ù…ÙŠÙ‹Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                displayAdvancedStats({ fetchedUsersCount: fetchedUsers.length, failedIds: failedIds });

                document.getElementById('stats').style.display = 'flex';
                document.getElementById('searchInput').style.display = 'block';
                document.getElementById('searchInput').value = '';

                // Ø¹Ø±Ø¶ Ø£ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù…
                if (fetchedUsers.length > 0) {
                    document.getElementById('userInfoCard').style.display = 'block';
                    displayUserInfo(fetchedUsers[0]);
                } else {
                    document.getElementById('userInfoCard').style.display = 'none';
                }

                if (failedIds.length > 0) {
                    showToast(`ØªÙ… Ø¬Ù„Ø¨ ${fetchedUsers.length} Ù…Ø³ØªØ®Ø¯Ù…ØŒ ÙØ´Ù„ ${failedIds.length}`);
                } else {
                    showToast(`ØªÙ… Ø¬Ù„Ø¨ ${fetchedUsers.length} Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­`);
                }
            };

            window.clearApi = function() {
                document.getElementById('sessionToken').value = 'r:ad6f7cf8f71a2637eee5a154ad511f55';
                document.getElementById('userIdsInput').value = '';
                clearAllData();
            };

            window.loadSampleIds = function() {
                // Ù†Ø¶Ø¹ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù€ IDs Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                document.getElementById('userIdsInput').value = `["uFW8Q24WIb", "iz4Q7sGGZp", "9qJlqcaSNp"]`;
                // ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§
            };

            // ---------- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© ----------
            function displayImages(images) {
                const container = document.getElementById('imagesContainer');
                container.innerHTML = '';
                if (images.length === 0) {
                    container.innerHTML = '<div class="empty-state">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</div>';
                    return;
                }
                images.sort((a,b) => (a.order || 999) - (b.order || 999));
                images.forEach((img, idx) => {
                    const card = document.createElement('div');
                    card.className = 'image-card';

                    const preview = document.createElement('img');
                    preview.className = 'image-preview';
                    preview.src = img.url;
                    preview.loading = 'lazy';
                    preview.onerror = () => { preview.src = 'https://placehold.co/300x300/e2e8f0/475569?text=Ø®Ø·Ø£'; };
                    preview.onclick = () => openModal(idx);
                    card.appendChild(preview);

                    const badgesDiv = document.createElement('div');
                    badgesDiv.className = 'badges';
                    if (img.order) {
                        const orderSpan = document.createElement('span');
                        orderSpan.className = 'badge-order';
                        orderSpan.innerHTML = `<i class="fas fa-sort"></i> ${img.order}`;
                        badgesDiv.appendChild(orderSpan);
                    } else {
                        badgesDiv.appendChild(document.createElement('span'));
                    }
                    if (img.isPrivate) {
                        const privateSpan = document.createElement('span');
                        privateSpan.className = 'badge-private';
                        privateSpan.innerHTML = '<i class="fas fa-lock"></i> Ø®Ø§Øµ';
                        badgesDiv.appendChild(privateSpan);
                    }
                    card.appendChild(badgesDiv);

                    const urlDiv = document.createElement('div');
                    urlDiv.className = 'image-url';
                    urlDiv.textContent = img.url.length > 40 ? img.url.substring(0,40)+'â€¦' : img.url;
                    card.appendChild(urlDiv);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'image-actions';

                    const copyUrlBtn = document.createElement('button');
                    copyUrlBtn.innerHTML = '<i class="fas fa-copy"></i> Ø±Ø§Ø¨Ø·';
                    copyUrlBtn.onclick = (e) => {
                        e.stopPropagation();
                        navigator.clipboard.writeText(img.url).then(() => showToast('ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·'));
                    };
                    actionsDiv.appendChild(copyUrlBtn);

                    const downloadBtn = document.createElement('button');
                    downloadBtn.innerHTML = '<i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„';
                    downloadBtn.onclick = (e) => {
                        e.stopPropagation();
                        const a = document.createElement('a');
                        a.href = img.url;
                        a.download = img.url.split('/').pop() || 'image.jpg';
                        a.click();
                    };
                    actionsDiv.appendChild(downloadBtn);

                    if (img.userHandle) {
                        const handleBtn = document.createElement('button');
                        handleBtn.innerHTML = '<i class="fas fa-user"></i> Ù…Ø¹Ø±Ù';
                        handleBtn.onclick = (function(handle) {
                            return function(e) {
                                e.stopPropagation();
                                navigator.clipboard.writeText(handle).then(() => showToast('ğŸ‘¤ ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù'));
                            };
                        })(img.userHandle);
                        actionsDiv.appendChild(handleBtn);
                    }

                    card.appendChild(actionsDiv);
                    container.appendChild(card);
                });
            }

            function displayLocations(locations) {
                const container = document.getElementById('locationsContainer');
                if (!locations.length) {
                    container.innerHTML = '<div class="empty-state">ğŸ“ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ù‚Ø¹</div>';
                    return;
                }
                let html = '';
                locations.forEach((loc, i) => {
                    const mapSrc = `https://www.google.com/maps?q=${loc.latitude},${loc.longitude}&output=embed`;
                    html += `
                        <div class="location-item">
                            <div style="display:flex; justify-content:space-between;">
                                <span><i class="fas fa-map-pin" style="color:var(--accent);"></i> ${loc.name}</span>
                                <small>${i+1}</small>
                            </div>
                            <div class="coord-row">
                                <span>Ø·: ${loc.longitude}</span>
                                <span>Ø¹: ${loc.latitude}</span>
                            </div>
                            <div class="map-placeholder">
                                <iframe src="${mapSrc}" loading="lazy"></iframe>
                            </div>
                            <div class="location-actions">
                                <button onclick="copyCoordinates(${loc.latitude}, ${loc.longitude})"><i class="fas fa-copy"></i> Ù†Ø³Ø®</button>
                                <a href="https://www.google.com/maps?q=${loc.latitude},${loc.longitude}" target="_blank"><i class="fas fa-external-link-alt"></i> ÙØªØ­</a>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }

            function displayUserInfo(user) {
                const container = document.getElementById('userInfo');
                const fields = {
                    name: 'Ø§Ù„Ø§Ø³Ù…',
                    age: 'Ø§Ù„Ø¹Ù…Ø±',
                    height: 'Ø§Ù„Ø·ÙˆÙ„',
                    weight: 'Ø§Ù„ÙˆØ²Ù†',
                    userHandle: 'Ø§Ù„Ù…Ø¹Ø±Ù',
                    profileText: 'Ù†Ø¨Ø°Ø©',
                    userSexRole: 'Ø§Ù„Ø¯ÙˆØ±',
                    userEthnicity: 'Ø§Ù„Ø£ØµÙ„'
                };
                let html = '';
                for (let [key, label] of Object.entries(fields)) {
                    if (user[key] !== undefined) {
                        html += `
                            <div class="user-item">
                                <div class="label">${label}</div>
                                <div class="value">${user[key]}</div>
                            </div>
                        `;
                    }
                }
                container.innerHTML = html || '<div class="empty-state" style="grid-column:span2;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
            }

            function updateStats(images, locations) {
                const statsDiv = document.getElementById('stats');
                const privateCount = images.filter(i => i.isPrivate).length;
                const handlesCount = images.filter(i => i.userHandle).length;
                statsDiv.innerHTML = `
                    <div class="stat-card"><i class="fas fa-image"></i> Ø§Ù„ØµÙˆØ±: ${images.length}</div>
                    <div class="stat-card"><i class="fas fa-lock"></i> Ø®Ø§Øµ: ${privateCount}</div>
                    <div class="stat-card"><i class="fas fa-map-marker-alt"></i> Ù…ÙˆØ§Ù‚Ø¹: ${locations.length}</div>
                    <div class="stat-card"><i class="fas fa-user"></i> Ù…Ø¹Ø±ÙØ§Øª: ${handlesCount}</div>
                `;
            }

            function displayAdvancedStats(data) {
                const container = document.getElementById('advancedStats');
                if (data.fetchedUsersCount !== undefined) {
                    // Ù…Ù† API
                    container.innerHTML = `
                        <div style="background:var(--bg); padding:16px; border-radius:12px;">
                            <p><i class="fas fa-users"></i> ØªÙ… Ø¬Ù„Ø¨: ${data.fetchedUsersCount} Ù…Ø³ØªØ®Ø¯Ù…</p>
                            <p><i class="fas fa-exclamation-triangle"></i> ÙØ´Ù„: ${data.failedIds?.length || 0}</p>
                            <p><i class="fas fa-clock"></i> ${new Date().toLocaleString('ar')}</p>
                        </div>
                    `;
                } else {
                    // Ù…Ù† JSON
                    const countKeys = (obj) => {
                        if (!obj || typeof obj !== 'object') return 0;
                        let c = 0;
                        for (let k in obj) {
                            if (obj.hasOwnProperty(k)) c++;
                            if (typeof obj[k] === 'object') c += countKeys(obj[k]);
                        }
                        return c;
                    };
                    const totalKeys = countKeys(data);
                    const jsonSize = new Blob([JSON.stringify(data)]).size;
                    container.innerHTML = `
                        <div style="background:var(--bg); padding:16px; border-radius:12px;">
                            <p><i class="fas fa-key"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„: ${totalKeys}</p>
                            <p><i class="fas fa-weight"></i> Ø§Ù„Ø­Ø¬Ù…: ${(jsonSize/1024).toFixed(2)} KB</p>
                            <p><i class="fas fa-clock"></i> ${new Date().toLocaleString('ar')}</p>
                        </div>
                    `;
                }
            }

            // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            function clearAllData() {
                document.getElementById('imagesContainer').innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø¨Ø¹Ø¯</div>';
                document.getElementById('locationsContainer').innerHTML = '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ù‚Ø¹</div>';
                document.getElementById('userInfoCard').style.display = 'none';
                document.getElementById('stats').style.display = 'none';
                document.getElementById('searchInput').style.display = 'none';
                document.getElementById('advancedStats').innerHTML = '';
                currentImages = [];
                currentLocations = [];
            }

            // Ø¯Ø§Ù„Ø© Ù†Ø³Ø® Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
            window.copyCoordinates = function(lat, lon) {
                navigator.clipboard.writeText(`${lat}, ${lon}`).then(() => showToast('ğŸ“ ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª'));
            };

            // Ø§Ù„Ø¨Ø­Ø«
            document.getElementById('searchInput').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = currentImages.filter(img => img.url.toLowerCase().includes(term));
                displayImages(filtered);
            });

            // Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØµÙˆØ±
            function openModal(index) {
                if (!currentImages.length) return;
                currentImageIndex = index;
                document.getElementById('modalImage').src = currentImages[index].url;
                document.getElementById('imageModal').style.display = 'flex';
            }
            window.openModal = openModal;

            window.closeModal = function(e) {
                if (e.target.classList.contains('modal') || e.target.classList.contains('modal-close')) {
                    document.getElementById('imageModal').style.display = 'none';
                }
            };

            window.prevImage = function(e) {
                e.stopPropagation();
                if (currentImageIndex > 0) {
                    currentImageIndex--;
                    document.getElementById('modalImage').src = currentImages[currentImageIndex].url;
                }
            };

            window.nextImage = function(e) {
                e.stopPropagation();
                if (currentImageIndex < currentImages.length - 1) {
                    currentImageIndex++;
                    document.getElementById('modalImage').src = currentImages[currentImageIndex].url;
                }
            };

            // Ø¹ÙŠÙ†Ø© Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„
            window.loadSample = function() {
                const sample = {
                    result: {
                        users: [
                            { name: 'Ø£Ø­Ù…Ø¯', age: 25, userHandle: 'ahmed123', location: { longitude: 54.37, latitude: 24.45 }, userImages: [{ order: 1, isPrivate: false, imageFile: { url: 'https://placehold.co/400/3b82f6/white?text=ØµÙˆØ±Ø©+1' } }] },
                            { name: 'Ø³Ø§Ø±Ø©', userHandle: 'sara_22', location: { longitude: 54.38, latitude: 24.46 }, userImages: [{ order: 1, isPrivate: false, imageFile: { url: 'https://placehold.co/400/10b981/white?text=ØµÙˆØ±Ø©+2' } }] }
                        ]
                    }
                };
                document.getElementById('jsonInput').value = JSON.stringify(sample, null, 2);
                parseJSON();
            };

            // Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„
            const dropArea = document.getElementById('jsonInput');
            if (dropArea) {
                dropArea.addEventListener('dragover', e => e.preventDefault());
                dropArea.addEventListener('drop', e => {
                    e.preventDefault();
                    const file = e.dataTransfer.files[0];
                    if (file && file.type === 'application/json') {
                        const reader = new FileReader();
                        reader.onload = ev => {
                            dropArea.value = ev.target.result;
                            parseJSON();
                        };
                        reader.readAsText(file);
                    } else {
                        showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø³Ù‚Ø§Ø· Ù…Ù„Ù JSON ØµØ§Ù„Ø­');
                    }
                });
            }
        })();
    </script>
</body>
</html>
