<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Ø¹Ø§Ø±Ø¶ JSON - Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù Ù„ÙƒÙ„ ØµÙˆØ±Ø©</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        :root {
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --accent: #2563eb;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.05);
            --radius-lg: 20px;
            --radius-md: 14px;
            --radius-sm: 10px;
        }

        body {
            background: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h1 i {
            color: var(--accent);
        }

        textarea {
            width: 100%;
            height: 150px;
            padding: 14px;
            border: 1.5px solid var(--border);
            border-radius: var(--radius-md);
            background: var(--bg-surface);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            direction: ltr;
            resize: vertical;
            margin-bottom: 16px;
            transition: 0.15s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        button {
            padding: 10px 18px;
            border: none;
            border-radius: 40px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: 0.15s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
            flex: 1 1 auto;
            min-width: 80px;
        }

        button.primary {
            background: var(--accent);
            color: white;
            border: none;
        }

        button.primary:hover {
            background: #3b82f6;
        }

        button:hover {
            background: #e2e8f0;
        }

        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .stat-item {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            box-shadow: var(--shadow);
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .image-card {
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: 0.15s;
        }

        .image-card:active {
            transform: scale(0.98);
        }

        .image-preview {
            width: 100%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            background: var(--bg-body);
            cursor: pointer;
        }

        .badges {
            padding: 8px 8px 4px;
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
        }

        .order-badge {
            background: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
        }

        .private-badge {
            background: #f97316;
            color: white;
            padding: 2px 8px;
            border-radius: 20px;
        }

        .image-url {
            padding: 0 8px 8px;
            font-size: 0.65rem;
            color: var(--text-secondary);
            word-break: break-all;
            direction: ltr;
        }

        .image-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 0 8px 8px;
        }

        .image-actions button {
            flex: 1 1 auto;
            background: var(--bg-body);
            border: 1px solid var(--border);
            border-radius: 30px;
            padding: 6px 4px;
            font-size: 0.7rem;
            color: var(--text-primary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
            min-width: 50px;
        }

        .image-actions button:hover {
            background: var(--accent);
            color: white;
        }

        .empty-state {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px;
            grid-column: 1 / -1;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: white;
            padding: 10px 24px;
            border-radius: 40px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 0.9rem;
            z-index: 2000;
            animation: fadeInOut 2s ease forwards;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
            15% { opacity: 1; transform: translateX(-50%) translateY(0); }
            85% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-cube"></i> JSON Ø¹Ø§Ø±Ø¶</h1>

        <textarea id="jsonInput" placeholder="Ø§Ù„ØµÙ‚ JSON Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù…Ù„Ù..."></textarea>

        <div class="btn-group">
            <button class="primary" onclick="parseJSON()"><i class="fas fa-play"></i> ØªØ­Ù„ÙŠÙ„</button>
            <button onclick="pasteJSON()"><i class="fas fa-paste"></i> Ù„ØµÙ‚</button>
            <button onclick="clearAll()"><i class="fas fa-trash"></i> Ù…Ø³Ø­</button>
            <button onclick="loadSample()"><i class="fas fa-flask"></i> Ø¹ÙŠÙ†Ø©</button>
        </div>

        <div id="stats" class="stats" style="display: none;"></div>

        <div id="imagesContainer" class="images-grid">
            <div class="empty-state">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø¨Ø¹Ø¯</div>
        </div>
    </div>

    <script>
        // ---------- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ----------
        let currentImages = [];      // Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙˆØ± Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§
        let globalUserHandle = null; // Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø§Ù… Ø¥Ù† ÙˆØ¬Ø¯

        // ---------- Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© toast ----------
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // ---------- Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø© ----------
        async function pasteJSON() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('jsonInput').value = text;
                parseJSON();
            } catch (err) {
                showToast('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø§ÙØ¸Ø©ØŒ Ø§Ù„ØµÙ‚ ÙŠØ¯ÙˆÙŠØ§Ù‹');
            }
        }

        // ---------- ØªØ­Ù„ÙŠÙ„ JSON ----------
        function parseJSON() {
            const jsonStr = document.getElementById('jsonInput').value.trim();
            if (!jsonStr) {
                showToast('Ø£Ø¯Ø®Ù„ JSON Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            try {
                const data = JSON.parse(jsonStr);
                
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØ±
                const images = [];
                const seenUrls = new Set();  // Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±

                function extract(obj) {
                    if (!obj || typeof obj !== 'object') return;

                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø©
                    if (obj.url && typeof obj.url === 'string' && /\.(jpg|jpeg|png|gif|webp|bmp)(\?.*)?$/i.test(obj.url)) {
                        const url = obj.url;
                        if (!seenUrls.has(url)) {
                            seenUrls.add(url);
                            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ø±Ù Ø®Ø§Øµ Ø¨Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©
                            let userHandle = null;
                            if (obj.userHandle) userHandle = obj.userHandle;
                            if (obj.user && obj.user.userHandle) userHandle = obj.user.userHandle;

                            images.push({
                                url: url,
                                order: obj.order || null,
                                isPrivate: obj.isPrivate || false,
                                userHandle: userHandle   // Ù‚Ø¯ ÙŠÙƒÙˆÙ† null
                            });
                        }
                    }

                    // Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù…Ù‚
                    for (let key in obj) {
                        if (obj.hasOwnProperty(key)) {
                            const val = obj[key];
                            if (val && typeof val === 'object') {
                                extract(val);
                            }
                        }
                    }
                }

                extract(data);

                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø¹Ø§Ù… Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± result.user.userHandle
                let globalHandle = null;
                try {
                    if (data.result && data.result.user && data.result.user.userHandle) {
                        globalHandle = data.result.user.userHandle;
                    }
                } catch (e) {}

                globalUserHandle = globalHandle;

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø§Ù… Ù„ÙƒÙ„ ØµÙˆØ±Ø© Ù„Ø§ ØªÙ…Ù„Ùƒ Ù…Ø¹Ø±ÙØ§Ù‹ Ø®Ø§ØµØ§Ù‹
                if (globalUserHandle) {
                    images.forEach(img => {
                        if (!img.userHandle) {
                            img.userHandle = globalUserHandle;
                        }
                    });
                }

                currentImages = images;

                // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                displayImages();
                updateStats();

            } catch (e) {
                showToast('âŒ JSON ØºÙŠØ± ØµØ§Ù„Ø­: ' + e.message);
            }
        }

        // ---------- Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ© ----------
        function displayImages() {
            const container = document.getElementById('imagesContainer');
            container.innerHTML = '';  // ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚

            if (currentImages.length === 0) {
                container.innerHTML = '<div class="empty-state">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</div>';
                return;
            }

            // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ order (Ø¥Ø°Ø§ ÙˆØ¬Ø¯)
            const sorted = [...currentImages].sort((a, b) => (a.order || 999) - (b.order || 999));

            sorted.forEach((img, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';

                // Ø§Ù„ØµÙˆØ±Ø©
                const imgEl = document.createElement('img');
                imgEl.className = 'image-preview';
                imgEl.src = img.url;
                imgEl.loading = 'lazy';
                imgEl.onerror = () => { imgEl.src = 'https://placehold.co/300x300/e2e8f0/475569?text=Ø®Ø·Ø£'; };
                imgEl.onclick = () => window.open(img.url, '_blank');  // ÙØªØ­ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
                card.appendChild(imgEl);

                // Ø§Ù„Ø´Ø§Ø±Ø§Øª
                const badgesDiv = document.createElement('div');
                badgesDiv.className = 'badges';

                if (img.order) {
                    const orderSpan = document.createElement('span');
                    orderSpan.className = 'order-badge';
                    orderSpan.innerHTML = `<i class="fas fa-sort"></i> ${img.order}`;
                    badgesDiv.appendChild(orderSpan);
                } else {
                    // Ù†Ø¶Ø¹ Ø¹Ù†ØµØ± ÙØ§Ø±Øº Ù„Ù„Ù…Ø­Ø§Ø°Ø§Ø©
                    badgesDiv.appendChild(document.createElement('span'));
                }

                if (img.isPrivate) {
                    const privateSpan = document.createElement('span');
                    privateSpan.className = 'private-badge';
                    privateSpan.innerHTML = '<i class="fas fa-lock"></i> Ø®Ø§Øµ';
                    badgesDiv.appendChild(privateSpan);
                } else {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø®Ø§ØµØ§Ù‹ØŒ Ù„Ø§ Ù†Ø¶ÙŠÙ Ø´ÙŠØ¡
                }

                card.appendChild(badgesDiv);

                // Ø¹Ù†ÙˆØ§Ù† URL Ù…Ø®ØªØµØ±
                const urlDiv = document.createElement('div');
                urlDiv.className = 'image-url';
                urlDiv.textContent = img.url.length > 40 ? img.url.substring(0, 40) + 'â€¦' : img.url;
                card.appendChild(urlDiv);

                // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'image-actions';

                // Ø²Ø± Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
                const copyUrlBtn = document.createElement('button');
                copyUrlBtn.innerHTML = '<i class="fas fa-copy"></i> Ø±Ø§Ø¨Ø·';
                copyUrlBtn.onclick = (e) => {
                    e.stopPropagation();
                    navigator.clipboard.writeText(img.url).then(() => showToast('ğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·'));
                };
                actionsDiv.appendChild(copyUrlBtn);

                // Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                const downloadBtn = document.createElement('button');
                downloadBtn.innerHTML = '<i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„';
                downloadBtn.onclick = (e) => {
                    e.stopPropagation();
                    const a = document.createElement('a');
                    a.href = img.url;
                    a.download = img.url.split('/').pop() || 'image.jpg';
                    a.click();
                };
                actionsDiv.appendChild(downloadBtn);

                // Ø²Ø± Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©
                if (img.userHandle) {
                    const copyHandleBtn = document.createElement('button');
                    copyHandleBtn.innerHTML = '<i class="fas fa-user"></i> Ù…Ø¹Ø±Ù';
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥ØºÙ„Ø§Ù‚ (closure) Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©
                    copyHandleBtn.onclick = (function(handle) {
                        return function(e) {
                            e.stopPropagation();
                            navigator.clipboard.writeText(handle).then(() => showToast('ğŸ‘¤ ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù'));
                        };
                    })(img.userHandle);
                    actionsDiv.appendChild(copyHandleBtn);
                }

                card.appendChild(actionsDiv);
                container.appendChild(card);
            });
        }

        // ---------- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ----------
        function updateStats() {
            const statsDiv = document.getElementById('stats');
            if (currentImages.length === 0) {
                statsDiv.style.display = 'none';
                return;
            }

            const privateCount = currentImages.filter(img => img.isPrivate).length;
            const publicCount = currentImages.length - privateCount;
            const handlesCount = currentImages.filter(img => img.userHandle).length;

            statsDiv.innerHTML = `
                <div class="stat-item"><i class="fas fa-image"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${currentImages.length}</div>
                <div class="stat-item"><i class="fas fa-lock"></i> Ø®Ø§Øµ: ${privateCount}</div>
                <div class="stat-item"><i class="fas fa-globe"></i> Ø¹Ø§Ù…: ${publicCount}</div>
                <div class="stat-item"><i class="fas fa-user"></i> Ù…Ø¹Ø±ÙØ§Øª: ${handlesCount}</div>
            `;
            statsDiv.style.display = 'flex';
        }

        // ---------- Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„ ----------
        function clearAll() {
            document.getElementById('jsonInput').value = '';
            document.getElementById('imagesContainer').innerHTML = '<div class="empty-state">ğŸš« Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø¨Ø¹Ø¯</div>';
            document.getElementById('stats').style.display = 'none';
            currentImages = [];
            globalUserHandle = null;
        }

        // ---------- ØªØ­Ù…ÙŠÙ„ Ø¹ÙŠÙ†Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© ----------
        function loadSample() {
            const sample = {
                result: {
                    user: {
                        name: 'Ø³Ø§Ø±Ø©',
                        userHandle: 'sara_22',
                        userImages: [
                            { order: 1, isPrivate: false, imageFile: { url: 'https://placehold.co/400/3b82f6/white?text=ØµÙˆØ±Ø©+1' } },
                            { order: 2, isPrivate: true, imageFile: { url: 'https://placehold.co/400/f97316/white?text=ØµÙˆØ±Ø©+2' } },
                            { order: 3, isPrivate: false, imageFile: { url: 'https://placehold.co/400/10b981/white?text=ØµÙˆØ±Ø©+3' } }
                        ]
                    }
                }
            };
            document.getElementById('jsonInput').value = JSON.stringify(sample, null, 2);
            parseJSON();
        }

        // ---------- Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª Ø§Ù„Ù…Ù„Ù ----------
        const dropArea = document.getElementById('jsonInput');
        dropArea.addEventListener('dragover', e => e.preventDefault());
        dropArea.addEventListener('drop', e => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = ev => {
                    dropArea.value = ev.target.result;
                    parseJSON();
                };
                reader.readAsText(file);
            } else {
                showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø³Ù‚Ø§Ø· Ù…Ù„Ù JSON ØµØ§Ù„Ø­');
            }
        });

        // ---------- ØªØ­Ù…ÙŠÙ„ Ø¹ÙŠÙ†Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø© ----------
        window.onload = function() {
            loadSample();  // ØªØ¬Ø±Ø¨Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        };
    </script>
</body>
</html>
